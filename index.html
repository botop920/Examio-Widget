<!DOCTYPE html>
<html>
<body>

<h3>Examio Debug Loader</h3>

<script>
(async function () {

  const params = new URLSearchParams(window.location.search);

  const embedToken = params.get("embed_token");
  const batchToken = params.get("batch_token");

  document.body.innerHTML += `<p>Token: ${embedToken}</p>`;
  document.body.innerHTML += `<p>Batch: ${batchToken}</p>`;

  window.addEventListener("message", async (event) => {

    try {

      const parentDomain = event.data.domain;

      document.body.innerHTML += `<p>Domain received: ${parentDomain}</p>`;

      if (!parentDomain) return;

      const res = await fetch(
        "https://lvjtqqnxtrbxeozjrsku.supabase.co/functions/v1/verify-embed",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2anRxcW54dHJieGVvempyc2t1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MDc3MzEsImV4cCI6MjA4NTI4MzczMX0.Kfn2VXculf1SMWkaleOIM9qRraOzoNmsTnD8HKPirO4"
          },
          body: JSON.stringify({
            token: embedToken,
            referrer: "https://" + parentDomain
          })
        }
      );

      const data = await res.json();

      document.body.innerHTML += `<p>Verify result: ${JSON.stringify(data)}</p>`;

      if (!data.allow) {
        document.body.innerHTML += "<p>Blocked ‚ùå</p>";
        return;
      }

      document.body.innerHTML += "<p>Loading exam...</p>";

      const iframe = document.createElement("iframe");

      iframe.src = `https://www.examio.xyz/?batch_token=${batchToken}&embed=true`;

      iframe.style.width = "100%";
      iframe.style.height = "700px";

      document.body.appendChild(iframe);

    } catch (e) {

      document.body.innerHTML += `<p style="color:red">CRASH: ${e}</p>`;

    }

  });

})();
</script>

</body>
</html>

